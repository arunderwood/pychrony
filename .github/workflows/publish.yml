name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish-pypi:
    name: Publish to Production PyPI
    runs-on: ubuntu-latest
    environment: pypi

    steps:
    - name: Download x86_64 wheel artifacts
      uses: dawidd6/action-download-artifact@v12
      with:
        workflow: release.yml
        name: wheels-x86_64
        path: dist/
        search_artifacts: true
        workflow_conclusion: success
        commit: ${{ github.event.inputs.release_tag }}
        if_no_artifact_found: fail

    - name: Download aarch64 wheel artifacts
      uses: dawidd6/action-download-artifact@v12
      with:
        workflow: release.yml
        name: wheels-aarch64
        path: dist/
        search_artifacts: true
        workflow_conclusion: success
        commit: ${{ github.event.inputs.release_tag }}
        if_no_artifact_found: fail

    - name: Download sdist artifact
      uses: dawidd6/action-download-artifact@v12
      with:
        workflow: release.yml
        name: sdist
        path: dist/
        search_artifacts: true
        workflow_conclusion: success
        commit: ${{ github.event.inputs.release_tag }}
        if_no_artifact_found: fail

    - name: List artifacts
      run: ls -la dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
