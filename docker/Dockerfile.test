# Test environment for pychrony with libchrony and chronyd
# Based on Fedora - builds libchrony from source

FROM fedora:40

# Install system dependencies (chrony for chronyd, build tools for libchrony)
RUN dnf install -y \
    chrony \
    gcc \
    make \
    libtool \
    git \
    python3 \
    python3-pip \
    python3-devel \
    && dnf clean all

# Build and install libchrony from source
RUN git clone https://gitlab.com/chrony/libchrony.git /tmp/libchrony && \
    cd /tmp/libchrony && \
    make && \
    make install prefix=/usr/local DESTDIR= && \
    echo "/usr/local/lib" > /etc/ld.so.conf.d/local.conf && \
    ldconfig && \
    rm -rf /tmp/libchrony

# Create chrony socket directory with correct permissions
RUN mkdir -p /run/chrony && chown chrony:chrony /run/chrony && chmod 750 /run/chrony

# Configure chronyd for testing (local reference clock + Unix socket)
RUN echo "local stratum 10" >> /etc/chrony.conf && \
    echo "allow 127.0.0.1" >> /etc/chrony.conf && \
    echo "cmdallow 127.0.0.1" >> /etc/chrony.conf && \
    echo "cmdport 0" >> /etc/chrony.conf && \
    echo "bindcmdaddress /run/chrony/chronyd.sock" >> /etc/chrony.conf

# Install UV for Python package management
RUN pip3 install uv

# Set working directory
WORKDIR /app

# Copy project files
COPY pyproject.toml .
COPY README.md .
COPY src/ src/
COPY tests/ tests/

# Install project dependencies
RUN uv pip install --system -e "." && \
    uv pip install --system pytest pytest-cov setuptools

# Build CFFI bindings (requires libchrony headers)
# ffi.compile() outputs to /app/pychrony/_core/, but editable install is at /app/src/pychrony/
RUN python3 -c "from pychrony._core._build_bindings import ffi; ffi.compile(verbose=True)" && \
    cp /app/pychrony/_core/_cffi_bindings*.so /app/src/pychrony/_core/

# Default command: run all tests
CMD ["pytest", "tests/", "-v"]
